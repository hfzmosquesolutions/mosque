-- WARNING: This schema is for context only and is not meant to be run.
-- Table order and constraints may not be valid for execution.

CREATE TABLE public.announcements (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  mosque_id uuid NOT NULL,
  title character varying NOT NULL,
  content text NOT NULL,
  priority USER-DEFINED DEFAULT 'medium'::announcement_priority,
  is_published boolean DEFAULT false,
  published_at timestamp with time zone,
  expires_at timestamp with time zone,
  target_audience jsonb DEFAULT '{}'::jsonb,
  image_url text,
  created_by uuid NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT announcements_pkey PRIMARY KEY (id),
  CONSTRAINT announcements_mosque_id_fkey FOREIGN KEY (mosque_id) REFERENCES public.mosques(id),
  CONSTRAINT announcements_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.user_profiles(id)
);
CREATE TABLE public.audit_logs (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  user_id uuid,
  mosque_id uuid,
  action character varying NOT NULL,
  table_name character varying,
  record_id uuid,
  old_values jsonb,
  new_values jsonb,
  ip_address inet,
  user_agent text,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT audit_logs_pkey PRIMARY KEY (id),
  CONSTRAINT audit_logs_mosque_id_fkey FOREIGN KEY (mosque_id) REFERENCES public.mosques(id),
  CONSTRAINT audit_logs_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.user_profiles(id)
);
CREATE TABLE public.claim_documents (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  claim_id uuid NOT NULL,
  file_name character varying NOT NULL,
  file_url text NOT NULL,
  file_type character varying,
  file_size integer,
  uploaded_by uuid NOT NULL,
  uploaded_at timestamp with time zone DEFAULT now(),
  CONSTRAINT claim_documents_pkey PRIMARY KEY (id),
  CONSTRAINT claim_documents_claim_id_fkey FOREIGN KEY (claim_id) REFERENCES public.khairat_claims(id),
  CONSTRAINT claim_documents_uploaded_by_fkey FOREIGN KEY (uploaded_by) REFERENCES public.user_profiles(id)
);
CREATE TABLE public.claim_history (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  claim_id uuid NOT NULL,
  action character varying NOT NULL,
  old_status USER-DEFINED,
  new_status USER-DEFINED,
  notes text,
  performed_by uuid NOT NULL,
  performed_at timestamp with time zone DEFAULT now(),
  CONSTRAINT claim_history_pkey PRIMARY KEY (id),
  CONSTRAINT claim_history_claim_id_fkey FOREIGN KEY (claim_id) REFERENCES public.khairat_claims(id),
  CONSTRAINT claim_history_performed_by_fkey FOREIGN KEY (performed_by) REFERENCES public.user_profiles(id)
);
CREATE TABLE public.contribution_programs (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  mosque_id uuid NOT NULL,
  name character varying NOT NULL,
  description text,
  target_amount numeric,
  current_amount numeric DEFAULT 0,
  start_date date,
  end_date date,
  is_active boolean DEFAULT true,
  created_by uuid NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  program_type text DEFAULT 'khairat'::text CHECK (program_type = ANY (ARRAY['khairat'::text, 'zakat'::text, 'infaq'::text, 'sadaqah'::text, 'general'::text, 'education'::text, 'maintenance'::text])),
  CONSTRAINT contribution_programs_pkey PRIMARY KEY (id),
  CONSTRAINT contribution_programs_mosque_id_fkey FOREIGN KEY (mosque_id) REFERENCES public.mosques(id),
  CONSTRAINT contribution_programs_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.user_profiles(id)
);
CREATE TABLE public.contributions (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  program_id uuid NOT NULL,
  contributor_id uuid,
  contributor_name character varying,
  amount numeric NOT NULL,
  payment_method character varying,
  payment_reference character varying,
  status USER-DEFINED DEFAULT 'pending'::contribution_status,
  notes text,
  contributed_at timestamp with time zone DEFAULT now(),
  payment_data jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  bill_id text,
  CONSTRAINT contributions_pkey PRIMARY KEY (id),
  CONSTRAINT contributions_program_id_fkey FOREIGN KEY (program_id) REFERENCES public.contribution_programs(id),
  CONSTRAINT khairat_contributions_contributor_id_fkey FOREIGN KEY (contributor_id) REFERENCES public.user_profiles(id)
);
CREATE TABLE public.donation_categories (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  mosque_id uuid NOT NULL,
  name character varying NOT NULL,
  description text,
  target_amount numeric,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT donation_categories_pkey PRIMARY KEY (id),
  CONSTRAINT donation_categories_mosque_id_fkey FOREIGN KEY (mosque_id) REFERENCES public.mosques(id)
);
CREATE TABLE public.donations (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  mosque_id uuid NOT NULL,
  donor_id uuid,
  donor_name character varying,
  donor_email character varying,
  donor_phone character varying,
  category_id uuid,
  amount numeric NOT NULL,
  currency character varying DEFAULT 'MYR'::character varying,
  payment_method character varying,
  payment_reference character varying,
  status USER-DEFINED DEFAULT 'pending'::donation_status,
  is_anonymous boolean DEFAULT false,
  is_recurring boolean DEFAULT false,
  recurring_frequency character varying,
  notes text,
  receipt_url text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT donations_pkey PRIMARY KEY (id),
  CONSTRAINT donations_mosque_id_fkey FOREIGN KEY (mosque_id) REFERENCES public.mosques(id),
  CONSTRAINT donations_donor_id_fkey FOREIGN KEY (donor_id) REFERENCES public.user_profiles(id),
  CONSTRAINT donations_category_id_fkey FOREIGN KEY (category_id) REFERENCES public.donation_categories(id)
);
CREATE TABLE public.event_registrations (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  event_id uuid NOT NULL,
  user_id uuid NOT NULL,
  registered_at timestamp with time zone DEFAULT now(),
  attended boolean DEFAULT false,
  notes text,
  CONSTRAINT event_registrations_pkey PRIMARY KEY (id),
  CONSTRAINT event_registrations_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.user_profiles(id),
  CONSTRAINT event_registrations_event_id_fkey FOREIGN KEY (event_id) REFERENCES public.events(id)
);
CREATE TABLE public.events (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  mosque_id uuid NOT NULL,
  title character varying NOT NULL,
  description text,
  event_date timestamp with time zone NOT NULL,
  end_date timestamp with time zone,
  location text,
  max_attendees integer,
  registration_required boolean DEFAULT false,
  registration_deadline timestamp with time zone,
  status USER-DEFINED DEFAULT 'draft'::event_status,
  category character varying,
  image_url text,
  created_by uuid NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT events_pkey PRIMARY KEY (id),
  CONSTRAINT events_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.user_profiles(id),
  CONSTRAINT events_mosque_id_fkey FOREIGN KEY (mosque_id) REFERENCES public.mosques(id)
);
CREATE TABLE public.kariah_applications (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  mosque_id uuid NOT NULL,
  ic_passport_number character varying NOT NULL,
  application_reason text,
  supporting_documents jsonb DEFAULT '[]'::jsonb,
  status character varying DEFAULT 'pending'::character varying CHECK (status::text = ANY (ARRAY['pending'::character varying, 'approved'::character varying, 'rejected'::character varying, 'under_review'::character varying]::text[])),
  reviewed_by uuid,
  reviewed_at timestamp with time zone,
  review_notes text,
  matched_legacy_records_count integer DEFAULT 0,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  notes text,
  admin_notes text,
  CONSTRAINT kariah_applications_pkey PRIMARY KEY (id),
  CONSTRAINT kariah_applications_mosque_id_fkey FOREIGN KEY (mosque_id) REFERENCES public.mosques(id),
  CONSTRAINT kariah_applications_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.user_profiles(id),
  CONSTRAINT kariah_applications_reviewed_by_fkey FOREIGN KEY (reviewed_by) REFERENCES public.user_profiles(id)
);
CREATE TABLE public.kariah_memberships (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  mosque_id uuid NOT NULL,
  membership_number character varying UNIQUE,
  status character varying DEFAULT 'active'::character varying CHECK (status::text = ANY (ARRAY['active'::character varying, 'inactive'::character varying, 'suspended'::character varying]::text[])),
  joined_date date DEFAULT CURRENT_DATE,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  notes text,
  admin_notes text,
  CONSTRAINT kariah_memberships_pkey PRIMARY KEY (id),
  CONSTRAINT kariah_memberships_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.user_profiles(id),
  CONSTRAINT kariah_memberships_mosque_id_fkey FOREIGN KEY (mosque_id) REFERENCES public.mosques(id)
);
CREATE TABLE public.khairat_claims (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  mosque_id uuid NOT NULL,
  claimant_id uuid NOT NULL,
  program_id uuid,
  title character varying NOT NULL,
  description text NOT NULL,
  requested_amount numeric NOT NULL CHECK (requested_amount > 0::numeric),
  approved_amount numeric CHECK (approved_amount IS NULL OR approved_amount >= 0::numeric),
  status USER-DEFINED DEFAULT 'pending'::claim_status,
  priority USER-DEFINED DEFAULT 'medium'::claim_priority,
  reason_category character varying,
  supporting_documents jsonb DEFAULT '[]'::jsonb,
  admin_notes text,
  rejection_reason text,
  disbursement_method character varying,
  disbursement_reference character varying,
  disbursed_at timestamp with time zone,
  reviewed_by uuid,
  reviewed_at timestamp with time zone,
  approved_by uuid,
  approved_at timestamp with time zone,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT khairat_claims_pkey PRIMARY KEY (id),
  CONSTRAINT khairat_claims_approved_by_fkey FOREIGN KEY (approved_by) REFERENCES public.user_profiles(id),
  CONSTRAINT khairat_claims_mosque_id_fkey FOREIGN KEY (mosque_id) REFERENCES public.mosques(id),
  CONSTRAINT khairat_claims_program_id_fkey FOREIGN KEY (program_id) REFERENCES public.contribution_programs(id),
  CONSTRAINT khairat_claims_claimant_id_fkey FOREIGN KEY (claimant_id) REFERENCES public.user_profiles(id),
  CONSTRAINT khairat_claims_reviewed_by_fkey FOREIGN KEY (reviewed_by) REFERENCES public.user_profiles(id)
);
CREATE TABLE public.legacy_khairat_records (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  mosque_id uuid NOT NULL,
  ic_passport_number character varying NOT NULL,
  full_name character varying NOT NULL,
  address_line1 text,
  address_line2 text,
  address_line3 text,
  invoice_number character varying,
  payment_date date NOT NULL,
  amount numeric NOT NULL,
  payment_method character varying,
  description text,
  customer_po character varying,
  item_number character varying,
  sale_status character varying,
  is_matched boolean DEFAULT false,
  matched_user_id uuid,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  created_by uuid NOT NULL,
  CONSTRAINT legacy_khairat_records_pkey PRIMARY KEY (id),
  CONSTRAINT legacy_khairat_records_mosque_id_fkey FOREIGN KEY (mosque_id) REFERENCES public.mosques(id),
  CONSTRAINT legacy_khairat_records_matched_user_id_fkey FOREIGN KEY (matched_user_id) REFERENCES public.user_profiles(id),
  CONSTRAINT legacy_khairat_records_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.user_profiles(id)
);
CREATE TABLE public.mosque_followers (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  user_id uuid NOT NULL,
  mosque_id uuid NOT NULL,
  followed_at timestamp with time zone DEFAULT now(),
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT mosque_followers_pkey PRIMARY KEY (id),
  CONSTRAINT mosque_followers_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id),
  CONSTRAINT mosque_followers_mosque_id_fkey FOREIGN KEY (mosque_id) REFERENCES public.mosques(id)
);
CREATE TABLE public.mosque_payment_providers (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  mosque_id uuid NOT NULL,
  provider_type USER-DEFINED NOT NULL,
  is_active boolean DEFAULT true,
  is_sandbox boolean DEFAULT true,
  billplz_api_key text,
  billplz_x_signature_key text,
  billplz_collection_id text,
  chip_brand_id text,
  chip_api_key text,
  stripe_publishable_key text,
  stripe_secret_key text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  toyyibpay_secret_key text,
  toyyibpay_category_code text,
  CONSTRAINT mosque_payment_providers_pkey PRIMARY KEY (id),
  CONSTRAINT mosque_payment_providers_mosque_id_fkey FOREIGN KEY (mosque_id) REFERENCES public.mosques(id)
);
CREATE TABLE public.mosque_user_followers (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  mosque_id uuid NOT NULL,
  user_id uuid NOT NULL,
  followed_at timestamp with time zone DEFAULT now(),
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT mosque_user_followers_pkey PRIMARY KEY (id),
  CONSTRAINT mosque_user_followers_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id),
  CONSTRAINT mosque_user_followers_mosque_id_fkey FOREIGN KEY (mosque_id) REFERENCES public.mosques(id)
);
CREATE TABLE public.mosques (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  name character varying NOT NULL,
  address text,
  phone character varying,
  email character varying,
  website character varying,
  description text,
  prayer_times jsonb,
  settings jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  user_id uuid UNIQUE,
  is_private boolean DEFAULT false,
  logo_url text,
  banner_url text,
  CONSTRAINT mosques_pkey PRIMARY KEY (id),
  CONSTRAINT mosques_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id)
);
CREATE TABLE public.notifications (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  user_id uuid NOT NULL,
  mosque_id uuid,
  title character varying NOT NULL,
  message text NOT NULL,
  type character varying NOT NULL,
  is_read boolean DEFAULT false,
  action_url text,
  metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone DEFAULT now(),
  read_at timestamp with time zone,
  CONSTRAINT notifications_pkey PRIMARY KEY (id),
  CONSTRAINT notifications_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.user_profiles(id),
  CONSTRAINT notifications_mosque_id_fkey FOREIGN KEY (mosque_id) REFERENCES public.mosques(id)
);
CREATE TABLE public.resource_categories (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  mosque_id uuid NOT NULL,
  name character varying NOT NULL,
  description text,
  parent_id uuid,
  sort_order integer DEFAULT 0,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT resource_categories_pkey PRIMARY KEY (id),
  CONSTRAINT resource_categories_parent_id_fkey FOREIGN KEY (parent_id) REFERENCES public.resource_categories(id),
  CONSTRAINT resource_categories_mosque_id_fkey FOREIGN KEY (mosque_id) REFERENCES public.mosques(id)
);
CREATE TABLE public.resources (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  mosque_id uuid NOT NULL,
  category_id uuid,
  title character varying NOT NULL,
  description text,
  content text,
  file_url text,
  external_url text,
  resource_type character varying,
  language character varying DEFAULT 'en'::character varying,
  tags ARRAY,
  is_featured boolean DEFAULT false,
  is_published boolean DEFAULT false,
  view_count integer DEFAULT 0,
  created_by uuid NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT resources_pkey PRIMARY KEY (id),
  CONSTRAINT resources_category_id_fkey FOREIGN KEY (category_id) REFERENCES public.resource_categories(id),
  CONSTRAINT resources_mosque_id_fkey FOREIGN KEY (mosque_id) REFERENCES public.mosques(id),
  CONSTRAINT resources_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.user_profiles(id)
);
CREATE TABLE public.system_settings (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  mosque_id uuid,
  key character varying NOT NULL,
  value jsonb NOT NULL,
  description text,
  is_public boolean DEFAULT false,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT system_settings_pkey PRIMARY KEY (id),
  CONSTRAINT system_settings_mosque_id_fkey FOREIGN KEY (mosque_id) REFERENCES public.mosques(id)
);
CREATE TABLE public.user_dependents (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  user_id uuid NOT NULL,
  full_name character varying NOT NULL,
  relationship character varying NOT NULL,
  date_of_birth date,
  gender character varying,
  phone character varying,
  email character varying,
  address text,
  emergency_contact boolean DEFAULT false,
  notes text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT user_dependents_pkey PRIMARY KEY (id),
  CONSTRAINT user_dependents_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.user_profiles(id)
);
CREATE TABLE public.user_followers (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  follower_id uuid NOT NULL,
  following_id uuid NOT NULL,
  followed_at timestamp with time zone DEFAULT now(),
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT user_followers_pkey PRIMARY KEY (id),
  CONSTRAINT user_followers_following_id_fkey FOREIGN KEY (following_id) REFERENCES auth.users(id),
  CONSTRAINT user_followers_follower_id_fkey FOREIGN KEY (follower_id) REFERENCES auth.users(id)
);
CREATE TABLE public.user_profiles (
  id uuid NOT NULL,
  full_name character varying NOT NULL,
  phone character varying,
  address text,
  account_type USER-DEFINED NOT NULL DEFAULT 'member'::user_account_type,
  membership_type USER-DEFINED DEFAULT 'regular'::membership_type,
  role USER-DEFINED NOT NULL DEFAULT 'member'::user_role,
  status USER-DEFINED NOT NULL DEFAULT 'active'::user_status,
  emergency_contact_name character varying,
  emergency_contact_phone character varying,
  date_of_birth date,
  gender character varying,
  occupation character varying,
  onboarding_completed boolean DEFAULT false,
  onboarding_completed_at timestamp with time zone,
  profile_picture_url text,
  preferences jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  is_profile_private boolean DEFAULT false,
  ic_passport_number text,
  CONSTRAINT user_profiles_pkey PRIMARY KEY (id),
  CONSTRAINT user_profiles_id_fkey FOREIGN KEY (id) REFERENCES auth.users(id)
);